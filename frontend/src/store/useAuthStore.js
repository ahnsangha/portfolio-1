/* -----------------------------------------------------------------------------------
 * íŒŒì¼ ì´ë¦„    : useAuthStore.js
 * ì„¤ëª…         : Zustand ê¸°ë°˜ ì¸ì¦(Store) ê´€ë¦¬ ëª¨ë“ˆ - ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ ë° ê´€ë ¨ ì•¡ì…˜ ì œê³µ
 * ì£¼ìš” ê¸°ëŠ¥    :
 *   1) authUser, isSigningUp, isLoggingIn, isUpdatingProfile, isCheckingAuth, onlineUsers ìƒíƒœ ê´€ë¦¬
 *   2) checkAuth: ì„œë²„ë¡œ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
 *   3) signup: íšŒì›ê°€ì… API í˜¸ì¶œ ë° authUser ì„¤ì •
 *   4) login: ë¡œê·¸ì¸ API í˜¸ì¶œ ë° authUser ì„¤ì •
 *   5) logout: ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
 *   6) updateProfile: í”„ë¡œí•„ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ ë° ìƒíƒœ ê°±ì‹ 
 *   7) deleteAccount: íšŒì›íƒˆí‡´ í˜¸ì¶œ ë° authUser ì„¤ì •
 * ----------------------------------------------------------------------------------- */

import { create } from "zustand";
import { axiosInstance } from "../lib/axios";
import toast from "react-hot-toast";
import { useChatStore } from "./useChatStore";

const localAuth = localStorage.getItem("authUser");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) Store ì´ˆê¸°í™” ë° ìƒíƒœ ì •ì˜
//    - authUser: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µì›ëœ ì‚¬ìš©ì ì •ë³´
//    - ë¡œë”© ë° ì¸ì¦ ê´€ë ¨ í”Œë˜ê·¸(isSigningUp, isLoggingIn, isUpdatingProfile, isCheckingAuth)
//    - onlineUsers: í˜„ì¬ ì˜¨ë¼ì¸ ì‚¬ìš©ì ID ëª©ë¡
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const useAuthStore = create((set) => ({
  authUser: localAuth ? JSON.parse(localAuth) : null,
  isSigningUp: false,
  isLoggingIn: false,
  isUpdatingProfile: false,
  isCheckingAuth: true,
  isDeletingAccount: false,
  onlineUsers: [],

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2) checkAuth ì•¡ì…˜
  //    - ì„œë²„ë¡œ í˜„ì¬ ì¸ì¦ ìƒíƒœ í™•ì¸(GET /api/status)
  //    - authUser ìƒíƒœ ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
  //    - ì™„ë£Œ í›„ isCheckingAuth í”Œë˜ê·¸ í•´ì œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  checkAuth: async () => {
    try {
      const res = await axiosInstance.get("/api/status");
      set({ authUser: res.data });
      localStorage.setItem("authUser", JSON.stringify(res.data));
    } catch (error) {
      console.log("checkAuth error:", error);
      set({ authUser: null });
      localStorage.removeItem("authUser");
    } finally {
      set({ isCheckingAuth: false });
    }
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3) signup ì•¡ì…˜
  //    - íšŒì›ê°€ì… ìš”ì²­(POST /signup)
  //    - ì„±ê³µ ì‹œ authUser ìƒíƒœ ì„¤ì • ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
  //    - toastë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  signup: async (data) => {
    set({ isSigningUp: true });
    try {
      const res = await axiosInstance.post("/signup", data);
      if (res.data?.data) {
        set({ authUser: res.data.data });
        localStorage.setItem("authUser", JSON.stringify(res.data.data));
      }
      toast.success(res.data.message || "ê³„ì • ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (error) {
      toast.error(error.response?.data?.detail || "íšŒì›ê°€ì… ì‹¤íŒ¨");
      console.log("signup:" + error.response?.data?.message);
    } finally {
      set({ isSigningUp: false });
    }
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4) login ì•¡ì…˜
  //    - ë¡œê·¸ì¸ ìš”ì²­(POST /login)
  //    - ì„±ê³µ ì‹œ authUser ìƒíƒœ ì„¤ì • ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
  //    - toastë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  login: async (data) => {
    set({ isLoggingIn: true });
    try {
      const res = await axiosInstance.post("/login", data);
      if (res.data?.data) {
        set({ authUser: res.data.data });
        localStorage.setItem("authUser", JSON.stringify(res.data.data));
      }
      console.log("loginSuccess");
      toast.success(res.data.message || "ë¡œê·¸ì¸ ì„±ê³µ!");
    } catch (error) {
      toast.error(error.response?.data?.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
    } finally {
      set({ isLoggingIn: false });
    }
  },

  loginSuccess: (user) => {
    set({ authUser: user });
    const chat = useChatStore.getState();
    chat.$reset(); // ë©”ëª¨ë¦¬ í´ë¦¬ì–´
    chat.setSession(null);
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 5) logout ì•¡ì…˜
  //    - ë¡œê·¸ì•„ì›ƒ ìš”ì²­(POST /logout)
  //    - authUser ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì œê±°
  //    - toastë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  logout: async () => {
    try {
        // 1. ì„œë²„ì— ë¡œê·¸ì•„ì›ƒì„ ìš”ì²­í•˜ì—¬ ì„œë²„ ì„¸ì…˜ì„ ì •ë¦¬í•˜ê³  ì¿ í‚¤ ì‚­ì œ ì‘ë‹µ
        await axiosInstance.post("/logout");
        
    } catch (error) {
        // ì„œë²„ ìš”ì²­ì— ì‹¤íŒ¨í•˜ë”ë¼ë„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œëŠ” ë¡œê·¸ì•„ì›ƒì„ ì§„í–‰
        console.error("Logout API call failed:", error);
        toast.error(error.response?.data?.message || "ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
    } finally {
        // 2. í´ë¼ì´ì–¸íŠ¸ì˜ ëª¨ë“  ì¸ì¦ ì •ë³´ë¥¼ í™•ì‹¤í•˜ê²Œ ì œê±°.
        set({ authUser: null });
        localStorage.removeItem("authUser");
        useChatStore.getState().$reset(); // ì±„íŒ… ìƒíƒœ ì´ˆê¸°í™”
        
        // 3. ì¿ í‚¤ë¥¼ ì§ì ‘ ë§Œë£Œì‹œí‚¤ëŠ” ì½”ë“œë¥¼ ì¶”ê°€
        document.cookie = "token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";

        toast.success("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
},

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 6) updateProfile ì•¡ì…˜
  //    - í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ìš”ì²­(PUT /update-profile)
  //    - ì„±ê³µ ì‹œ authUser ìƒíƒœ ê°±ì‹ 
  //    - toastë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateProfile: async (data) => {
    set({ isUpdatingProfile: true });
    try {
      const res = await axiosInstance.put("/update-profile", data);
      if (res.data?.data) {
        set({ authUser: res.data.data });
        toast.success("í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    } catch (error) {
      console.error("í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨:", error);
      toast.error(error.response?.data?.message || "í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨");
      console.log("profile:" + error.response?.data?.message);
    } finally {
      set({ isUpdatingProfile: false });
    }
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 7) deleteAccount ì•¡ì…˜
  //    - íšŒì› íƒˆí‡´ ìš”ì²­(DELETE /delete-account)
  //    - ì„±ê³µ ì‹œ authUser ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€/ì¿ í‚¤ ì •ë¦¬
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deleteAccount: async () => {
    set({ isDeletingAccount: true }); // ğŸ‘ˆ ë¡œë”© ì‹œì‘
    try {
      await axiosInstance.delete("/delete-account");

      // ì„±ê³µ ì‹œ, í´ë¼ì´ì–¸íŠ¸ì—ì„œë„ ë¡œê·¸ì•„ì›ƒê³¼ ë™ì¼í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
      set({ authUser: null });
      localStorage.removeItem("authUser");
      useChatStore.getState().$reset(); // ì±„íŒ… ìƒíƒœ ì´ˆê¸°í™”
      document.cookie = "token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
      toast.success("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

    } catch (error) {
      console.error("íšŒì› íƒˆí‡´ ì‹¤íŒ¨:", error);
      toast.error(error.response?.data?.message || "íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      set({ isDeletingAccount: false }); // ğŸ‘ˆ ë¡œë”© ì¢…ë£Œ
    }
  },

}));

